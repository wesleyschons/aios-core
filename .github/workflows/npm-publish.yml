name: Publish to NPM
# Story 6.1 - Added concurrency
# Story 12.9 - Added @synkra/aios-install package support

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*.*.*'  # Semantic version tags trigger publish
  workflow_dispatch:
    inputs:
      publish_mode:
        description: 'Publishing mode'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - stable
          - beta
      packages:
        description: 'Packages to publish (comma-separated, or "all")'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - aios-core
          - aios-install

concurrency:
  group: npm-publish-${{ github.ref }}
  cancel-in-progress: false  # Never cancel publishing in progress

permissions:
  contents: read

env:
  NODE_VERSION: '20'
  NPM_REGISTRY: 'https://registry.npmjs.org/'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Run security audit
        # Note: Using critical level because high vulns are in dev deps (semantic-release, mocha)
        # These don't ship to production - only used for CI tooling
        # See: Story SEC-1 for security audit improvements
        run: npm audit --audit-level=critical --omit=dev || true

  build:
    needs: test
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.package-version.outputs.version }}
      packages: ${{ steps.detect-packages.outputs.packages }}
      has_aios_install: ${{ steps.detect-packages.outputs.has_aios_install }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get package version
        id: package-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Detect packages to publish
        id: detect-packages
        run: |
          SELECTED="${{ github.event.inputs.packages }}"

          # Default to all packages on release/tag events
          if [ -z "$SELECTED" ] || [ "$SELECTED" = "all" ]; then
            PACKAGES="aios-core"

            # Add aios-install if it exists
            if [ -d "packages/aios-install" ] && [ -f "packages/aios-install/package.json" ]; then
              PACKAGES="$PACKAGES,aios-install"
              echo "has_aios_install=true" >> $GITHUB_OUTPUT
            else
              echo "has_aios_install=false" >> $GITHUB_OUTPUT
            fi
          else
            PACKAGES="$SELECTED"
            if [ "$SELECTED" = "aios-install" ]; then
              echo "has_aios_install=true" >> $GITHUB_OUTPUT
            else
              echo "has_aios_install=false" >> $GITHUB_OUTPUT
            fi
          fi

          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Packages to publish: $PACKAGES"

      - name: Build all packages
        run: |
          # Create lib directories for packages that need them
          for pkg in .aios-core memory security performance telemetry; do
            if [ -d "$pkg" ]; then
              mkdir -p "$pkg/lib"
              echo '{"built": true}' > "$pkg/lib/build.json"
            fi
          done
          
          echo "âœ… Build preparation complete"

      - name: Create distribution archive
        run: |
          mkdir -p dist
          tar -czf dist/aios-core-${{ steps.package-version.outputs.version }}.tar.gz \
            --exclude=node_modules \
            --exclude=.git \
            --exclude=dist \
            --exclude=tests \
            --exclude='*.log' \
            .

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist/
            .aios-core/lib/
            memory/lib/
            security/lib/
            performance/lib/
            telemetry/lib/
          retention-days: 7

  publish:
    needs: [test, build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: ${{ env.NPM_REGISTRY }}

      - name: Install dependencies
        run: npm ci
        env:
          HUSKY: '0'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Set publishing tag
        id: publish-tag
        run: |
          if [ "${{ github.event.inputs.publish_mode }}" = "stable" ] || [ "${{ github.event_name }}" = "release" ]; then
            echo "tag=latest" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.publish_mode }}" = "beta" ]; then
            echo "tag=beta" >> $GITHUB_OUTPUT
          else
            echo "tag=preview" >> $GITHUB_OUTPUT
          fi

      - name: Publish safety gate (INS-4.10)
        run: node bin/utils/validate-publish.js

      - name: Check if aios-core should be published
        id: should-publish
        run: |
          PKG_NAME="aios-core"
          VERSION="${{ needs.build.outputs.version }}"

          # Check if package exists in registry
          if npm view "${PKG_NAME}@${VERSION}" version > /dev/null 2>&1; then
            echo "Version ${VERSION} already exists for ${PKG_NAME}"
            echo "should_publish=false" >> $GITHUB_OUTPUT
          else
            echo "Package ${PKG_NAME}@${VERSION} not found in registry"
            echo "should_publish=true" >> $GITHUB_OUTPUT
          fi

      - name: Publish aios-core to NPM
        if: steps.should-publish.outputs.should_publish == 'true'
        run: |
          # Create npmrc for authentication
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc

          # Publish with appropriate tag
          npm publish --tag ${{ steps.publish-tag.outputs.tag }} --access public

          echo "âœ… Published aios-core@${{ needs.build.outputs.version }} with tag ${{ steps.publish-tag.outputs.tag }}"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify publication
        if: steps.should-publish.outputs.should_publish == 'true'
        run: |
          # Wait for npm registry to propagate (can take up to 60s)
          for i in 1 2 3 4 5 6; do
            sleep 15
            if npm view "aios-core@${{ needs.build.outputs.version }}" version > /dev/null 2>&1; then
              echo "âœ… Verified: aios-core@${{ needs.build.outputs.version }} is available on NPM"
              exit 0
            fi
            echo "â³ Waiting for npm registry propagation... (attempt $i/6)"
          done

          echo "âŒ Verification failed: aios-core@${{ needs.build.outputs.version }} not found after 90s"
          exit 1

  # Story 12.9 - Publish @synkra/aios-install NPX package
  publish-aios-install:
    needs: [test, build]
    if: ${{ needs.build.outputs.has_aios_install == 'true' }}
    continue-on-error: true  # Don't block main publish if @synkra org not yet configured
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: ${{ env.NPM_REGISTRY }}

      - name: Install dependencies
        working-directory: packages/aios-install
        run: npm ci --ignore-scripts

      - name: Get aios-install version
        id: pkg-version
        working-directory: packages/aios-install
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Set publishing tag
        id: publish-tag
        run: |
          if [ "${{ github.event.inputs.publish_mode }}" = "stable" ] || [ "${{ github.event_name }}" = "release" ] || [ "${{ github.event_name }}" = "push" ]; then
            echo "tag=latest" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.publish_mode }}" = "beta" ]; then
            echo "tag=beta" >> $GITHUB_OUTPUT
          else
            echo "tag=preview" >> $GITHUB_OUTPUT
          fi

      - name: Check if already published
        id: should-publish
        run: |
          PKG_NAME="@synkra/aios-install"
          VERSION="${{ steps.pkg-version.outputs.version }}"

          if npm view "${PKG_NAME}@${VERSION}" version > /dev/null 2>&1; then
            echo "Version ${VERSION} already exists for ${PKG_NAME}"
            echo "should_publish=false" >> $GITHUB_OUTPUT
          else
            echo "Package ${PKG_NAME}@${VERSION} not found in registry"
            echo "should_publish=true" >> $GITHUB_OUTPUT
          fi

      - name: Publish @synkra/aios-install
        if: steps.should-publish.outputs.should_publish == 'true'
        working-directory: packages/aios-install
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc
          npm publish --tag ${{ steps.publish-tag.outputs.tag }} --access public
          echo "âœ… Published @synkra/aios-install@${{ steps.pkg-version.outputs.version }}"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Smoke test - verify npx works
        if: steps.should-publish.outputs.should_publish == 'true'
        run: |
          # Wait for npm registry propagation
          for i in 1 2 3 4 5 6; do
            sleep 15
            if npx @synkra/aios-install --version 2>/dev/null; then
              echo "âœ… Smoke test passed: npx @synkra/aios-install --version works"
              exit 0
            fi
            echo "â³ Waiting for npm propagation... (attempt $i/6)"
          done
          echo "âš ï¸ Smoke test timeout - package may need more time to propagate"
          # Don't fail the build - propagation can take longer

  notify:
    needs: [build, publish, publish-aios-install]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Notify completion
        run: |
          PUBLISHED_PACKAGES=""

          if [ "${{ needs.publish.result }}" = "success" ]; then
            PUBLISHED_PACKAGES="aios-core"
          fi

          if [ "${{ needs.publish-aios-install.result }}" = "success" ]; then
            if [ -n "$PUBLISHED_PACKAGES" ]; then
              PUBLISHED_PACKAGES="$PUBLISHED_PACKAGES, @synkra/aios-install"
            else
              PUBLISHED_PACKAGES="@synkra/aios-install"
            fi
          fi

          if [ -n "$PUBLISHED_PACKAGES" ]; then
            echo "ðŸŽ‰ Successfully published to NPM:"
            echo "   Packages: $PUBLISHED_PACKAGES"
            echo "   Registry: ${{ env.NPM_REGISTRY }}"
          elif [ "${{ needs.publish.result }}" = "skipped" ] && [ "${{ needs.publish-aios-install.result }}" = "skipped" ]; then
            echo "â­ï¸ No packages needed publishing (already up-to-date)"
          else
            echo "âŒ Publishing failed"
            exit 1
          fi

  create-release-notes:
    needs: [build, publish, publish-aios-install]
    if: github.event_name == 'release' && (needs.publish.result == 'success' || needs.publish-aios-install.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate release notes
        run: |
          # Check if aios-install was published
          AIOS_INSTALL_ROW=""
          if [ "${{ needs.publish-aios-install.result }}" = "success" ]; then
            AIOS_INSTALL_ROW="| @synkra/aios-install | [npmjs.com](https://www.npmjs.com/package/@synkra/aios-install) | NPX Installer for AIOS |"
          fi

          cat > release-notes.md << EOF
          # AIOS-Core v${{ needs.build.outputs.version }}

          ## ðŸ“¦ NPM Packages

          | Package | NPM Link | Description |
          |---------|----------|-------------|
          | aios-core | [npmjs.com](https://www.npmjs.com/package/aios-core) | AI-Orchestrated System for Full Stack Development |
          ${AIOS_INSTALL_ROW}

          ## ðŸš€ Installation

          \`\`\`bash
          # Quick install via NPX (recommended for new users)
          npx @synkra/aios-install

          # Or global installation
          npm install -g aios-core

          # Or as project dependency
          npm install aios-core
          \`\`\`

          ## ðŸ“‹ What's New

          * âœ… Complete Meta-Agent MVP and Framework Distribution
          * ðŸ”’ Security hardening with penetration testing
          * âš¡ Performance optimization framework
          * ðŸ“Š Privacy-conscious telemetry system
          * ðŸ“¦ Modular NPM package distribution

          ## ðŸ”— Links

          * [GitHub Repository](https://github.com/SynkraAI/aios-core)
          * [Documentation](https://github.com/SynkraAI/aios-core#readme)
          * [Issues](https://github.com/SynkraAI/aios-core/issues)
          EOF

      - name: Update release with notes
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const releaseNotes = fs.readFileSync('release-notes.md', 'utf8');

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: releaseNotes
            });